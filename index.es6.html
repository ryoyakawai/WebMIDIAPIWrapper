<html>
  <head>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

    <link rel="stylesheet" href="./css/style.css">
  </head>
  <body>

    <div class="midi-patches">

      <div class="midi-patch-selector">
        <select id="list-input-00" class="device-select"></select> ch: <input type="number" min="1" max="16" value="0" class="ch-select">
        <i class="material-icons">arrow_forward</i>
        <select id="list-output-00" class="device-select"></select> ch: <input type="number" min="1" max="16" value="0" class="ch-select">
      </div>
      
<!--
      <div class="midi-patch-selector">
        <select id="list-input-01" class="device-select"></select>
        <i class="material-icons">arrow_forward</i>
        <select id="list-output-01" class="device-select"></select>
      </div>

      <div class="midi-patch-selector">
        <select id="list-input-02" class="device-select"></select>
        <i class="material-icons">arrow_forward</i>
        <select id="list-output-02" class="device-select"></select>
      </div>

      <div class="midi-patch-selector">
        <select id="list-input-03" class="device-select"></select>
        <i class="material-icons">arrow_forward</i>
        <select id="list-output-03" class="device-select"></select>
      </div>

      <div class="midi-patch-selector">
        <select id="list-input-04" class="device-select"></select>
        <i class="material-icons">arrow_forward</i>
        <select id="list-output-04" class="device-select"></select>
      </div>
-->
    </div>
      
    <script type="module">
     import WebMIDIAPIWrapper from './js/webmidiapiwrapper.es6';
     
     (async function() {
       let list_input = []; let list_output = [];
       for(let i=0; i<document.querySelectorAll('.midi-patch-selector').length; i++) {
         let num = ('00' + i.toString()).substr(-2);
         list_input.push(document.querySelector(`#list-input-${num}`));
         list_output.push(document.querySelector(`#list-output-${num}`));
       }

       async function main(){
         const wmaw = new WebMIDIAPIWrapper();
         if( await wmaw.initMIDIAccess() === true ) {
           let midi_device_list = wmaw.getMIDIDeviceList();
           
           let self = wmaw;
           let ch = 0;
           list_input.map( midi_in => {
             updateDeviceSelectList('input', midi_device_list.input, midi_in);
             midi_in.addEventListener('change', event => {
               let selValue = midi_in[midi_in.selectedIndex].value;
               wmaw.setMIDIInputToPort(selValue, 0, event => {
                 event.data[0] = event.data[0]+1;
                 self.sendRaw(0, event.data, 0);
               });
             }, false);
             ch += 1;
           });

           ch = 0;
           list_output.map( midi_out => {
             updateDeviceSelectList('output', midi_device_list.output, midi_out);
             midi_out.addEventListener('change', event => {
               let selValue = midi_out[midi_out.selectedIndex].value;
               wmaw.setMIDIOutputToPort(selValue, 0);
             }, false);
             ch += 1;
           });

           wmaw.setStateChangeHandler( ( type, midi_device_list ) => {
             let target_elems = (type == 'output') ? list_output : list_input;
             target_elems.map( elem => {
               updateDeviceSelectList(type, midi_device_list, elem);
             });
           });
           

           /*
           updateDeviceSelectList('input', midi_device_list.input, list_input);
           list_input.addEventListener('change', event => {
             let selValue = list_input[list_input.selectedIndex].value;
             let self = wmaw;
             wmaw.setMIDIInputToPort(selValue, 0, event => {
               event.data[0] = event.data[0] + 1;
               self.sendRaw(0, event.data, 0);
             });
           }, false);
           
           updateDeviceSelectList('output', midi_device_list.output, list_output);
           list_output.addEventListener('change', event => {
             let selValue = list_output[list_output.selectedIndex].value;
             wmaw.setMIDIOutputToPort(selValue, 0);
           }, false);

           wmaw.setStateChangeHandler( ( type, midi_device_list ) => {
             let target_elem = (type == 'output') ? list_output : list_input;
             updateDeviceSelectList(type, midi_device_list, target_elem);
           });
            */

         }
       }

       const updateDeviceSelectList = ( type, midi_device_list, target_elem ) => {
         let selected_idx = getSelectedIdx(target_elem[target_elem.selectedIndex]);
         target_elem.innerHTML = '<option value="">[Select One]</option>';
         for(let i=0; i<midi_device_list.length; i++) {
           let device = midi_device_list[i];
           if(device['id'] == selected_idx.input) op_select = i + 1;
             
           let selected = false;
           if(device['id'] == selected_idx) selected = true;
           let op = new Option(device['name'], device['id'], false, selected);
           if( device.isAvailable === true ) target_elem.appendChild(op);
         }
         function getSelectedIdx(select_status){
           let selected_idx = '';
           if(typeof select_status !== 'undefined') {
             selected_idx = select_status.value;
           }
           return selected_idx;
         }
       };
              
       main();
       
     }());
    </script>
  </body>
</html>
